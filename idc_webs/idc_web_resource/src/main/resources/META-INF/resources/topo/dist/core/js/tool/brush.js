define(["element/Link","element/Node","element/Container","tool/util","tool/winHandler"],function(e,o,n,a,r){function t(e,o){var n=e;if($.each(o,function(e,o){n=n[o]}),!n)throw new Error("topo_brush's data path error"+o);return n}function i(i){function p(a){if(console.info("TOPO data:"),console.info(a),"string"==typeof a&&(a=$.parseJSON(a.replace(/'/g,'"'))),console.info("TOPO json:"),console.info(a),u.topo.stopFlag){var i=t(a,u.topo.stopFlag.split("."));if(!i||"number"==typeof i.length&&0==i.length)return console.info("trigger the stop flag"),r.getTools().progress({now:100,text:"no data to draw",error:!0}),"stop"}s.clear();var p;if(u.scene){p=u.scene.prop||{};var d=t(a,u.scene.source.split("."));s.prop.id=d.id||d[p.id]||"",s.prop.pid=d.pid||d[p.pid]||"",s.prop.name=d.name||d[p.name]||"",u.scene.exprop&&$.each(u.scene.exprop,function(e,o){s.exprop[e]=o})}var l=0,m=0;if(u.xy){p=u.xy.prop||{};var g=t(a,u.xy.source.split("."));if(l=parseInt(g.offsetX||g[p.offsetX]||0),m=parseInt(g.offsetY||g[p.offsetY]||0),u.xy.option)switch(u.xy.option){case"minus":l=-l,m=-m;break;case"add":}}if(s.prop.offsetX=l,s.prop.offsetY=m,u.node&&(p=u.node.prop||{},$.each(t(a,u.node.source.split(".")),function(e,n){var a=o.createNode({name:n.name||n[p.name],text:n.name||n[p.name],x:parseInt(n.x||n[p.x])+l,y:parseInt(n.y||n[p.y])+m,image:(u.node.imagePath||u.imagePath||"")+(n.image||n[p.image]||""),id:n.id||n[p.id],pid:n.pid||n[p.pid]});u.node.exprop&&$.each(u.node.exprop,function(e,o){a.exprop[e]=n[o]}),s.addElement(a)})),u.object&&(p=u.object.prop||{},$.each(t(a,u.object.source.split(".")),function(e,n){var a;switch(n.type){case"ztype.shape":a=o.createShape({name:n.name||n[p.name],text:n.name||n[p.name],id:n.id||n[p.id],pid:n.pid||n[p.pid],x:parseInt(n.x||n[p.x])+l,y:parseInt(n.y||n[p.y])+m,width:parseInt(n.width||n[p.width]),height:parseInt(n.height||n[p.height]),alpha:.5,nodeType:"ztype.shape"});break;case"ztype.topo":a=o.createNode({name:n.name||n[p.name],text:n.name||n[p.name],x:parseInt(n.x||n[p.x])+l,y:parseInt(n.y||n[p.y])+m,image:(u.object.imagePath||u.imagePath||"")+(n.image||n[p.image]||""),nodeType:"ztype.topo",id:n.id||n[p.id],pid:n.pid||n[p.pid]})}u.object.exprop&&$.each(u.object.exprop,function(e,o){a.exprop[e]=n[o]}),s.addElement(a)})),u.link){p=u.link.prop||{};var v;$.each(t(a,u.link.source.split(".")),function(o,n){v=e.directLink({start:s.findNode("id="+(n.start||n[p.start]))[0],end:s.findNode("id="+(n.end||n[p.end]))[0],text:n.name||n[p.name],name:n.name||n[p.name],id:n.id||n[p.id],pid:n.pid||n[p.pid]}),u.link.exprop&&$.each(u.link.exprop,function(e,o){v.exprop[e]=n[o]}),s.addElement(v)})}if(u.container){p=u.container.prop||{};var h;$.each(t(a,u.container.source.split(".")),function(e,o){h=n.create({name:o.name||o[p.name],text:o.name||o[p.name],id:o.id||o[p.id],pid:o.pid||o[p.pid]},s),$.each(o.object||o[p.object],function(e,o){var n=s.findNode("id="+o.id)[0];n&&"container"!=n.prop.nodeType&&h.addNode(n)}),$.each(o.node||o[p.node],function(e,o){var n=s.findNode("id="+o.id)[0];n&&h.addNode(n)}),u.container.exprop&&$.each(u.container.exprop,function(e,n){h.exprop[e]=o[n]}),s.addElement(h)})}return r.getToolBar().centerBtn.click(),r.getTools().progress({now:70,text:"正在绘制告警!"}),f[s.prop.config.brush].drawAlarm(s,c),"success"}var s=i.scene,c=i.id,d=i.fn;r.getTools().progress({now:30,text:"30%"});var u=s.prop.config;if(!u.topo||!u.topo.url)return console.info("need config topo"),void r.getTools().progress({now:100,text:"need config topo",error:!0});var m=u.topo.url;if(u.topo.params){var g="";$.each(u.topo.params,function(e,o){if(l&&(g=a.getParameter(o.key)),m+=0==e?"?"+o.key+"=":"&"+o.key+"=",g)m+=g;else switch(o.type){case"scenePid":m+=c?c:o.value;break;case"fixed":m+=o.value}}),l=!1}$.ajax({url:m,async:!0,type:"get",success:function(e){var o=p(e);s.prop.url=m,d&&$.isFunction(d)&&"success"==o&&d(e)},error:function(e){console.info("topo data empty"),r.getTools().progress({now:100,text:"topo data load empty",error:!0})}})}function p(e){return e.alarm&&e.alarm.url?(e.alarm.color||(e.alarm.color=["255,0,0","255, 102, 0","255,204,0","0,0,255"]),e.alarm.size||(e.alarm.size=20),e.alarm.font||(e.alarm.font="微软雅黑"),!0):(console.info("need config alarm_url"),r.getTools().progress({now:100,text:"100%"}),!1)}function s(e){function o(o){var a=o.node;return a?void $.each(a,function(o,a){var r=e.findNode("id="+a.id)[0];if(r){for(var t=0,i=n.alarm.color.length,p=n.alarm.color.length;p>0;p--)num=parseInt(a[p]),t+=num,num>0&&(i=p);r.drawAlarm({text:t,color:n.alarm.color[i-1],size:n.alarm.size,font:n.alarm.font,level:a.level})}}):(console.info("alarm data error"),!1)}var n=e.prop.config;p(n)&&(console.info("告警url:"+n.alarm.url),$.ajax({url:n.alarm.url,async:!0,type:"get",success:function(e){console.info("告警数据:"),console.info(e),o(e),r.getTools().progress({now:100,text:"100%"})},error:function(e){console.info("no alarm to draw"),r.getTools().progress({now:100,text:"100%",error:!0})}}))}function c(e){function o(o){if(o=n(o),!o)return void console.info("alarm data error");var r=o.dev;$.each(r,function(o,n){var r=e.findNode("id="+o)[0];r&&r.drawAlarm({text:n.num,color:a.alarm.color[n.level-1],size:a.alarm.size,font:a.alarm.font,level:n.level})})}function n(e){return"string"==typeof e&&(e=$.parseJSON(e.replace(/'/g,'"'))),e.seg?($.each(e.seg,function(o,n){5==o?(e.seg[1]=n,delete e.seg[o]):4==o&&(e.seg[2]=n,delete e.seg[o])}),$.each(e.dev,function(e,o){5==o.level&&(o.level=1),4==o.level&&(o.level=2)}),e):void console.info("alarm data error")}var a=e.prop.config;if(p(a)){var t="",i="";$.each(e.findNode(),function(e,o){o.prop.id&&(t+=o.prop.id+",")}),$.each(e.findLink(),function(e,o){o.prop.id&&(t+=o.prop.id+",")});var s=a.alarm.url+"?objId="+t+"&linkId="+i+"&areaId=1";console.info("告警url:"+s),$.ajax({url:s,async:!0,type:"get",success:function(e){console.info("告警数据:"),console.info(e),o(e),r.getTools().progress({now:100,text:"100%"})},error:function(e){console.info("no alarm to draw"),r.getTools().progress({now:100,text:"100%",error:!0})}})}}function d(e,o){var n=e.prop.config;if(n.save){var t=n.save.url;$.each(n.save.params,function(o,a){switch(t+=0==o?"?"+a.key+"=":"&"+a.key+"=",a.type){case"scene":t+=e.prop[a.value];break;case"fixed":t+=a.value;break;case"prop":var r=0,i=0;if(n.save.xy)switch(n.save.xy){case"minus":r=-e.prop.offsetX,i=-e.prop.offsetY;break;case"add":r=e.prop.offsetX,i=e.prop.offsetY}n.save.offsetX&&n.save.offsetY&&(r+=n.save.offsetX,i+=n.save.offsetY),$.each(e.findNode(),function(e,o){$.each(a.format.prop,function(e,n){switch(n){case"x":t+=parseInt(o.x)+r;break;case"y":t+=parseInt(o.y)+i;break;default:t+=o.prop[n]}e<a.format.prop.length-1&&(t+=a.format.divide)}),t+=a.divide})}})}a.ajax({url:t,do:function(e){o&&$.isFunction(o)&&o(e)},error:function(e){console.info(e),r.getTools().alert({content:"<h4>保存失败！</h4>"})}})}var l=!0,f=[{drawTopo:i,drawAlarm:s,saveTopo:d},{drawTopo:i,drawAlarm:c,saveTopo:d}];return f});
//# sourceMappingURL=brush.js.map